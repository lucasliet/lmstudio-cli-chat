#!/bin/bash

declare -a lmchat_messages
if [ -f /tmp/lmchat_messages ]; then
  readarray -t lmchat_messages < /tmp/lmchat_messages
else
  lmchat_messages=()
fi

model="hermes-3-llama-3.2-3b"
temperature=0.7

# Processar argumentos
while [[ $# -gt 0 ]]; do
  case $1 in
    --model)
      model="$2"
      shift 2
      ;;
    *)
      message="${message:+$message }$1"
      shift
      ;;
  esac
done

if [ -z "$message" ]; then
  echo "Usage: lmchat [--model model-name] your message"
  exit 1
fi

lmchat_messages+=("{\"role\": \"user\", \"content\": \"$message\"}")

messages_json=$(printf "%s," "${lmchat_messages[@]}")
messages_json="[${messages_json%,}]"

response=$(curl -s -X POST http://localhost:1234/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "messages": '"$messages_json"',
    "model": "'"$model"'",
    "temperature": '"$temperature"'
  }' | jq -r '.choices[0].message.content')

echo "$response"

lmchat_messages+=("{\"role\": \"assistant\", \"content\": \"$response\"}")

printf '%s\n' "${lmchat_messages[@]}" > /tmp/lmchat_messages
